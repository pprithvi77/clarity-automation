# n8n Workflow Setup Instructions

## Overview

This workflow automates the entire Clarity recording download process:
1. Monitors Google Sheet for new form submissions
2. Fetches recording URLs from Clarity API
3. Captures videos via the capture server
4. Updates sheet status and sends email notifications

## Import Instructions

1. Open n8n dashboard
2. Click **"Add workflow"** (or use existing)
3. Click the **⋮** menu (three dots) in top right
4. Select **"Import from file"**
5. Choose `clarity-workflow.json`

## Required Placeholders to Replace

After importing, you must update these placeholders in the workflow:

### 1. Google Sheet ID

**Find your Sheet ID:**
Your Google Sheet URL looks like:
```
https://docs.google.com/spreadsheets/d/1ABC123xyz789/edit
                                      ↑↑↑↑↑↑↑↑↑↑↑↑↑
                                      This is your Sheet ID
```

**Replace in these nodes:**
- `New Form Submission` (trigger node)
- `Update Status - Processing`
- `Update Status - Complete`
- `Update Status - Failed`

**How to replace:**
1. Double-click the node
2. Find `documentId` field
3. Replace `REPLACE_WITH_YOUR_GOOGLE_SHEET_ID` with your actual Sheet ID

### 2. Capture Server URL

**Replace in:**
- `Capture Recording` node

**Value:**
- Local: `http://localhost:3001/capture`
- Remote: `http://your-server-ip:3001/capture`

### 3. Credentials

**Google Sheets OAuth2:**
1. Go to Settings → Credentials → Add Credential
2. Select "Google Sheets OAuth2 API"
3. Enter your Google Cloud OAuth credentials:
   - Client ID
   - Client Secret
4. Click "Connect" and authorize access

**SMTP (for email notifications):**
1. Go to Settings → Credentials → Add Credential
2. Select "SMTP"
3. Configure:
   - Host: `smtp.gmail.com` (for Gmail)
   - Port: `587`
   - User: Your email
   - Password: App-specific password (for Gmail, generate at myaccount.google.com)

## Node-by-Node Setup Checklist

| Node | What to Configure |
|------|-------------------|
| **New Form Submission** | ☐ Sheet ID ☐ Credential |
| **Parse Form Data** | No changes needed |
| **Update Status - Processing** | ☐ Sheet ID ☐ Credential |
| **Fetch Clarity Recordings** | No changes needed (uses form data) |
| **Has Session Filter?** | No changes needed |
| **Filter by Session IDs** | No changes needed |
| **Process in Batches** | No changes needed |
| **Capture Recording** | ☐ Server URL |
| **Collect All Results** | No changes needed |
| **Update Status - Complete** | ☐ Sheet ID ☐ Credential |
| **Send Completion Email** | ☐ SMTP Credential |
| **On Error** | No changes needed |
| **Update Status - Failed** | ☐ Sheet ID ☐ Credential |
| **Send Error Email** | ☐ SMTP Credential |

## Google Sheet Column Requirements

Your Google Sheet (from form responses) should have these columns:

| Column | Header Name | Purpose |
|--------|-------------|---------|
| A | Timestamp | Auto-generated by form |
| B | Email Address | Customer email |
| C | Customer Name | Customer name |
| D | Clarity API Token | JWT token |
| E | Clarity Project ID | Project ID |
| F | **Clarity Cookies** | **REQUIRED** - Browser session cookies (JSON) |
| G | Download Type | Selection type |
| H | Start Date | Optional date |
| I | End Date | Optional date |
| J | Session IDs | Optional IDs |
| K | Max Recordings | Number limit |
| L | Status | **ADD THIS** - Updated by workflow |
| M | Result Link | **ADD THIS** - Updated by workflow |

**Important:**
- Add columns L (Status) and M (Result Link) manually to your sheet!
- **Clarity Cookies are REQUIRED** - The recording capture will fail without valid session cookies

## Getting Clarity Cookies

Clarity requires browser session cookies for authentication. Here's how to get them:

1. Install a cookie export extension (e.g., [EditThisCookie](https://chrome.google.com/webstore/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg))
2. Log into [Microsoft Clarity](https://clarity.microsoft.com) in your browser
3. Click the EditThisCookie extension icon
4. Click "Export" to copy cookies as JSON
5. Paste the JSON into the "Clarity Cookies" form field

**Cookie Expiry:** Cookies typically expire in 1-3 weeks. The workflow will notify you when cookies are expiring soon.

## Activating the Workflow

1. After all placeholders are replaced
2. Click the toggle switch in the top-right corner
3. The workflow is now active and monitoring for new submissions

## Testing

1. Submit a test entry through your Google Form
2. Go to **Executions** tab in n8n
3. Watch the workflow execute
4. Check your Google Sheet for status updates

## Troubleshooting

### "Credential not found"
- Verify credentials are set up in Settings → Credentials
- Re-connect the credential in each node

### "Sheet not found"
- Double-check Sheet ID is correct
- Ensure credential has access to the sheet

### "Connection refused" (Capture server)
- Verify server is running: `curl http://localhost:3001/health`
- Check firewall allows port 3001
- If remote, ensure server IP is correct

### Workflow doesn't trigger
- Verify workflow is activated (toggle is ON)
- Check that new rows are being added (not updated)
- Verify Google Sheets trigger is properly configured

## Customization Options

### Change batch size
In "Process in Batches" node, adjust `batchSize` (default: 3)

### Adjust timeout
In "Capture Recording" node, adjust `timeout` in options (default: 600000ms = 10 min)

### Modify email templates
Edit the `message` field in email nodes to customize notifications

### Skip email notifications
Delete or disable the email nodes if not needed
